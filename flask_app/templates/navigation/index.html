{% extends "navigation/subLayout.html" %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/navigation/styles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/navigation/index.css') }}">
{% endblock %}

{% block titleHeader %}{{ titleHeader }}{% endblock %}
{% block titleSubHeader %}{{ titleSubHeader }}{% endblock %}

{% block content %}
<div class="card-container" id="cards">
  <!-- Cards will be inserted here by JavaScript -->
</div>
{% endblock %}

{% block js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
      const cardsContainer = document.getElementById('cards');
      
      // Create error message element if it doesn't exist
      let errorMessage = document.getElementById('error-message');
      if (!errorMessage) {
        errorMessage = document.createElement('div');
        errorMessage.id = 'error-message';
        errorMessage.style.display = 'none';
        cardsContainer.parentNode.insertBefore(errorMessage, cardsContainer.nextSibling);
      }
      
      // Add loading indicator to card container
      cardsContainer.innerHTML = `
        <div style="text-align: center; padding: 40px; width: 100%;">
          <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; 
                      border-radius: 50%; border-top: 4px solid #3498db; animation: spin 1s linear infinite;"></div>
          <p style="margin-top: 20px; color: #666;">Loading delusions...</p>
        </div>
      `;
      
      // Add animation style
      const style = document.createElement('style');
      style.textContent = `
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `;
      document.head.appendChild(style);
      
      // Function to load all cards at once
      function loadAllCards() {
        // Use the data endpoint from your controller
        const url = "{{ url_for(mindObjectType|lower ~ '.get_data') }}";
        console.log('Fetching data from:', url);
        
        fetch(url)
          .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then(cards => {
            console.log('Received data:', cards);
            
            // Validate that we received an array
            if (!Array.isArray(cards)) {
              throw new Error(`Invalid response format. Expected array but got: ${typeof cards}`);
            }
            
            // Clear loading indicator
            cardsContainer.innerHTML = '';
            
            if (cards.length === 0) {
              cardsContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; width: 100%;">
                  <p style="color: #666;">No delusions found. Check back later for more content.</p>
                </div>
              `;
              return;
            }
            
            // Create cards from the data
            cards.forEach(card => {
              // Basic validation
              if (!card || typeof card !== 'object') {
                console.warn('Invalid card data:', card);
                return;
              }
              
              const cardElement = document.createElement('div');
              cardElement.className = 'card';
              
              // Get properties with fallbacks
              const title = card.title || 'Untitled';
              const content = card.content || 'No description available';
              
              // Build card HTML
              let cardHTML = `
                <h1>${title}</h1>
                <div class="card-separator"></div>
                <h2>${content}</h2>
              `;
              
              // Add subtopic if it exists
              if (card.subtopic) {
                cardHTML += `
                  <div style="margin-top: 10px; font-size: 0.9em;">
                    <strong>${card.subtopic}</strong>
                    <p>${card.subtopicDesc || ''}</p>
                  </div>
                `;
              }
              
              // Add tags if they exist
              if (card.tag) {
                cardHTML += `
                  <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
                    ${card.tag.split(',').map(tag => `#${tag.trim()}`).join(' ')}
                  </div>
                `;
              }
              
              cardElement.innerHTML = cardHTML;
              
              // Add click handler if needed
              cardElement.addEventListener('click', function() {
                console.log(`Card clicked: ${card.id}`);
                // Uncomment to navigate: window.location.href = `/delusions/${card.id}`;
              });
              
              cardsContainer.appendChild(cardElement);
            });
          })
          .catch(error => {
            console.error('Error fetching delusions:', error);
            
            // Show error message
            cardsContainer.innerHTML = `
              <div style="text-align: center; padding: 20px; margin: 20px; background: #fff; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <h3 style="color: #d9534f;">Error loading delusions</h3>
                <p style="color: #666;">Please try again later or contact support.</p>
                <div style="margin-top: 15px; font-family: monospace; text-align: left; background: #f8f8f8; padding: 10px; border-radius: 3px; font-size: 12px; color: #666; white-space: pre-wrap; word-break: break-all;">
                  ${error.message}
                </div>
                <button onclick="location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #5bc0de; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  Retry
                </button>
              </div>
            `;
          });
      }
      
      // Load all cards immediately
      loadAllCards();
    });
</script>
{% endblock %}